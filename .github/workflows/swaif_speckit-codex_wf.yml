name: Swaif Factory (Speckit + Codex CLI Full Cycle)

on:
  workflow_dispatch: 
jobs:
  swaif-speckit-cycle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Python 3.11 (for speckit specify-cli via uv)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv (Python package manager)
        run: pip install uv

      - name: Install speckit specify-cli from GitHub
        run: uv tool install specify-cli --from git+https://github.com/github/spec-kit.git

      - name: Install Codex CLI
        run: npm i -g @openai/codex

      # Optional: Combine templates if needed
      - name: Combine constitution and spec templates
        run: cat .swaif/engine/templates/swaif-constitution.md $GITHUB_WORKSPACE/specs/001-swaif-calc/spec.md > $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-combined-spec.md

      - name: Specify – Refine requirements from combined templates
        run: specify-cli /speckit.specify $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-combined-spec.md --output $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-spec.specific.md

      - name: Plan – Create plan from specific spec
        run: specify-cli /speckit.plan $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-spec.specific.md --output $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-plan.md

      - name: Tasks – Task breakdown from plan
        run: specify-cli /speckit.tasks $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-plan.md --output $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-tasks.md

      - name: Clarify – Clarification round (optional)
        run: specify-cli /speckit.clarify $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-tasks.md --output $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-clarification.md || echo "No clarifications needed"

      - name: Implement – Generate code from tasks (example with Codex CLI, adjust as needed)
        run: codex run "/speckit.implement $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-tasks.md --output-dir $GITHUB_WORKSPACE/specs/001-swaif-calc/"

      - name: Checklist – Validation checklist from tasks
        run: specify-cli /speckit.checklist $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-tasks.md --output $GITHUB_WORKSPACE/specs/001-swaif-calc/swaif-checklist.md

      # If you want to test/lint Python code, you may add steps like:
      - name: Install calculator requirements
        run: |
          if [ -f ./calculator/requirements.txt ]; then
            pip install -r $GITHUB_WORKSPACE/specs/001-swaif-calc/requirements.txt
          fi

      - name: Run tests (if generated)
        run: |
          if [ -d ./calculator/tests ]; then
            python -m unittest discover -s $GITHUB_WORKSPACE/specs/001-swaif-calc/tests
          fi

      - name: Lint code (flake8)
        run: |
          pip install flake8
          flake8 $GITHUB_WORKSPACE/specs/001-swaif-calc/
