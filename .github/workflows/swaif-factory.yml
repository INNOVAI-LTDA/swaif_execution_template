name: SWAIF Factory Worker

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      stage:
        description: "Stage to run (specify|plan|tasks|implement|verify)"
        required: true
        type: choice
        options: [specify, plan, tasks, implement, verify]
      feature_slug:
        description: "Feature folder name under specs/ (e.g., 001-clinic-finance-automation)"
        required: true
        type: string
      declared_execution_type:
        description: "Hands-On|Prototype|PoC|MVP|Research|Scaled Product"
        required: true
        type: choice
        options: ["Hands-On", "Prototype", "PoC", "MVP", "Research", "Scaled Product"]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: swaif-factory-${{ github.repository }}-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

jobs:
  run-stage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine stage
        id: stage
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "stage=${{ inputs.stage }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LABEL="${{ github.event.label.name }}"
          case "$LABEL" in
            swaif:specify)   echo "stage=specify"   >> "$GITHUB_OUTPUT" ;;
            swaif:plan)      echo "stage=plan"      >> "$GITHUB_OUTPUT" ;;
            swaif:tasks)     echo "stage=tasks"     >> "$GITHUB_OUTPUT" ;;
            swaif:implement) echo "stage=implement" >> "$GITHUB_OUTPUT" ;;
            swaif:verify)    echo "stage=verify"    >> "$GITHUB_OUTPUT" ;;
            *)               echo "stage=ignore"    >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Ignore unrelated labels
        if: steps.stage.outputs.stage == 'ignore'
        run: |
          echo "Ignoring label '${{ github.event.label.name }}'."
          exit 0

      - name: Read feature metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "feature_slug=${{ inputs.feature_slug }}" >> "$GITHUB_OUTPUT"
            echo "execution_type=${{ inputs.declared_execution_type }}" >> "$GITHUB_OUTPUT"
            echo "feature_dir=specs/${{ inputs.feature_slug }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BODY="${{ github.event.issue.body }}"
          # GitHub Issue Forms render as:
          # ### Feature Slug (SpecKit folder name)
          # value
          FEATURE_SLUG="$(printf "%s" "$BODY" | awk 'BEGIN{IGNORECASE=1} /^### Feature Slug/{getline; print; exit}' | tr -d '\r')"
          EXEC_TYPE="$(printf "%s" "$BODY" | awk 'BEGIN{IGNORECASE=1} /^### Declared Execution Type/{getline; print; exit}' | tr -d '\r')"

          if [ -z "$FEATURE_SLUG" ]; then
            echo "error=Missing 'Feature Slug' field in issue body (Issue Form)." >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -z "$EXEC_TYPE" ]; then
            echo "error=Missing 'Declared Execution Type' field in issue body (Issue Form)." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "feature_slug=$FEATURE_SLUG" >> "$GITHUB_OUTPUT"
          echo "execution_type=$EXEC_TYPE" >> "$GITHUB_OUTPUT"
          echo "feature_dir=specs/$FEATURE_SLUG" >> "$GITHUB_OUTPUT"

      - name: Comment and fail if metadata is missing
        if: steps.meta.outputs.feature_slug == '' && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const err = "${{ steps.meta.outputs.error }}";
            const msg = [
              "❌ **SWAIF Factory cannot run**",
              "",
              `Reason: ${err || "missing required fields"}`,
              "",
              "Fix the issue using the **SWAIF Feature (Factory Unit)** form (or ensure these sections exist):",
              "- `### Feature Slug`",
              "- `### Declared Execution Type`",
              "",
              "Then re-apply the stage label (e.g., `swaif:specify`)."
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: msg
            });
            core.setFailed("Missing required metadata.");

      - name: Run stage worker
        env:
          STAGE: ${{ steps.stage.outputs.stage }}
          FEATURE_DIR: ${{ steps.meta.outputs.feature_dir }}
          EXECUTION_TYPE: ${{ steps.meta.outputs.execution_type }}
          ISSUE_NUMBER: ${{ github.event.issue.number || 0 }}
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/swaif_stage.sh "$STAGE" "$FEATURE_DIR" "$EXECUTION_TYPE" "$ISSUE_NUMBER"

      - name: Create or update PR for the feature
        if: github.event_name != 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FEATURE_SLUG: ${{ steps.meta.outputs.feature_slug }}
          STAGE: ${{ steps.stage.outputs.stage }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="swaif/${FEATURE_SLUG}"
          TITLE="[SWAIF] ${FEATURE_SLUG} — ${STAGE}"
          BODY="Automated SWAIF stage: ${STAGE}\n\nCloses #${ISSUE_NUMBER}"

          # Create PR if missing; otherwise leave it.
          if [ "$(gh pr list --head "$BRANCH" --json number --jq 'length')" = "0" ]; then
            gh pr create --head "$BRANCH" --base "main" --title "$TITLE" --body "$BODY" || true
          else
            echo "PR already exists for $BRANCH"
          fi

      - name: On failure, mark blocked
        if: failure() && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              labels: ["swaif:blocked"]
            });
