name: SpecKit Cycle Automation

on:
    issues:
        types: [labeled]

jobs:
    speckit-cycle:
        runs-on: ubuntu-latest
        steps:
            # Step 1: Checkout your repo (and submodules)
            - name: Checkout repo (and submodules)
              uses: actions/checkout@v4
              with:
                  submodules: true

            # Step 2: Set up Node.js
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            # Step 3: INIT step when 'init' label is present
            - name: Install SpecKit CLI
              if: github.event.label.name == 'init'
              run: npm install -g @github/spec-kit

            - name: Run SpecKit Init
              if: github.event.label.name == 'init'
              run: specify init --config path/to/constitution.yaml

            # Step 4: Specify phase
            - name: Run Specify
              if: github.event.label.name == 'specify'
              run: |
                  specify generate --config path/to/constitution.yaml

            # Step 5: Plan phase
            - name: Run Plan
              if: github.event.label.name == 'plan'
              run: |
                  specify plan --config path/to/constitution.yaml

            # Step 6: Task phase
            - name: Run Task
              if: github.event.label.name == 'task'
              run: |
                  specify task --config path/to/constitution.yaml

            # Step 7: Implement phase
            - name: Run Implement
              if: github.event.label.name == 'implement'
              run: |
                  specify implement --config path/to/constitution.yaml

            # Step 8: Advance to next label
            - name: Progress to next label
              uses: actions/github-script@v7
              with:
                  script: |
                      const currentLabel = context.payload.label.name;
                      let nextLabelMap = {
                        'init': 'specify',
                        'specify': 'plan',
                        'plan': 'task',
                        'task': 'implement'
                      };
                      let nextLabel = nextLabelMap[currentLabel];
                      if (nextLabel) {
                        await github.issues.addLabels({
                          ...context.repo,
                          issue_number: context.payload.issue.number,
                          labels: [nextLabel]
                        });
                        await github.issues.removeLabel({
                          ...context.repo,
                          issue_number: context.payload.issue.number,
                          name: currentLabel
                        });
                      }
